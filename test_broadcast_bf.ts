import * as dotenv from 'dotenv';
// –í–ê–ñ–ù–û: –∑–∞–≥—Ä—É–∂–∞–µ–º .env –î–û –∏–º–ø–æ—Ä—Ç–∞ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
dotenv.config();

import { Telegraf, Markup } from 'telegraf';
import { AppDataSource } from './src/database';
import { User } from './src/entities/User';

const bot = new Telegraf(process.env.BOT_TOKEN!);
const IMAGE_PATH = './black friday.jpg';
const ADMIN_ID = 278263484;

// –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª–∞ –ø–æ –∏–º–µ–Ω–∏ (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
function detectGender(firstName: string | undefined): 'male' | 'female' | 'unknown' {
  if (!firstName) return 'unknown';
  
  const name = firstName.toLowerCase().trim();
  
  // –ñ–µ–Ω—Å–∫–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è (—Ä—É—Å—Å–∫–∏–µ/—É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∏–º–µ–Ω–∞)
  const femaleEndings = ['–∞', '—è', '–Ω–∞', '–ª–∞', '–∫–∞', '—à–∞', '—Å—è'];
  // –ò—Å–∫–ª—é—á–µ–Ω–∏—è - –º—É–∂—Å–∫–∏–µ –∏–º–µ–Ω–∞ –Ω–∞ '–∞'
  const maleExceptions = ['–Ω–∏–∫–∏—Ç–∞', '–∏–ª—å—è', '—Å–∞–≤–≤–∞', '–¥–∞–Ω–∏–ª–∞', '–¥–∞–Ωi–ª–∞', '–º–∏—à–∞', '—Å–∞—à–∞', '–∂–µ–Ω—è'];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
  if (maleExceptions.includes(name)) {
    return 'male';
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è
  for (const ending of femaleEndings) {
    if (name.endsWith(ending)) {
      return 'female';
    }
  }
  
  // –ï—Å–ª–∏ –Ω–µ –ø–æ–ø–∞–ª–∏ –≤ –∂–µ–Ω—Å–∫–∏–µ - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –º—É–∂—Å–∫–æ–µ
  return 'male';
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º –ø–æ–ª–∞
function generateMessage(firstName: string | undefined, gender: 'male' | 'female' | 'unknown'): string {
  const name = firstName || '–¥—Ä—É–≥';
  
  // –í–µ—Ä—Å–∏—è –¥–ª—è –∂–µ–Ω—â–∏–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  const femaleVersion = `${name}, –ü—Ä–∏–≤–µ—Ç! üëã –£ –º–µ–Ω—è –¥–ª—è —Ç–µ–±—è –¥–≤–µ –Ω–æ–≤–æ—Å—Ç–∏ ‚ù§Ô∏è

–°–µ–≥–æ–¥–Ω—è <b>–ß—ë—Ä–Ω–∞—è –ü—è—Ç–Ω–∏—Ü–∞</b>, –∏ —è –∫–æ–µ-—á—Ç–æ –¥–ª—è —Ç–µ–±—è –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª–∞‚Ä¶

üî• <b>–ü–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∑–∞ $25</b> ‚Äî —Ç–æ–ª—å–∫–æ 72 —á–∞—Å–∞
–ü–æ—Ç–æ–º –ø—Ä–æ–º—Ç—ã, –∫–∞—Ä—Ç–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤, –≤–æ—Ä–∫–±—É–∫ –∏ —á–∞—Ç —Å—Ç–∞–Ω—É—Ç —á–∞—Å—Ç—å—é –∫–ª—É–±–∞ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ $30/–º–µ—Å.

–ú—ã —Ä–∞—Å—à–∏—Ä—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —á–∞—Ç –¥–æ –∫–ª—É–±–∞ "<b>Reels –ú–∞—Å—Ç–µ—Ä–∞</b>": —Ä–∞–∑–±–æ—Ä—ã, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é, –∫–æ–º—å—é–Ω–∏—Ç–∏, –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã ‚Äî –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ, –∏ —Ü–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç.

–ù–æ –≤ —á–µ—Å—Ç—å –ß—ë—Ä–Ω–æ–π –ü—è—Ç–Ω–∏—Ü—ã –∏ –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã —É–∂–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞—Å—å –ø—Ä–æ–¥—É–∫—Ç–æ–º, <b>–∑–∞ —Ç–æ–±–æ–π –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –µ—â—ë 72 —á–∞—Å–∞.</b>

üíé <b>$25 –æ–¥–∏–Ω —Ä–∞–∑</b> ‚Üí –∏ –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω–æ –≤–Ω—É—Ç—Ä–∏:

üìä –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Å—ä—ë–º–∫–∏ —Ä–∏–ª—Å (34 —à—Ç)
ü§ñ 7 –ø—Ä–æ–º—Ç–æ–≤ –¥–ª—è —Å—ä—ë–º–∫–∏ —Ä–∏–ª—Å: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ê—Ä—Ö–µ—Ç–∏–ø–∞, –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¶–ê, –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 10 –∏–¥–µ–π, –ê–ø–≥—Ä–µ–π–¥ —Å—Ü–µ–Ω–∞—Ä–∏—è, –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –°–¢–ê, –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ö—É–∫–æ–≤, –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ–¥–ø–∏—Å–µ–π
üìà –í–æ—Ä–∫–±—É–∫-—Ç—Ä–µ–∫–µ—Ä –Ω–∞ 30 –¥–Ω–µ–π: –æ—Ç 0 –¥–æ 1000 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
üí¨ –î–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç–æ–µ –∫–æ–º–º—å—é–Ω–∏—Ç–∏ –≥–¥–µ –±—É–¥—É—Ç —ç—Ñ–∏—Ä—ã –∏ —Ä–∞–∑–±–æ—Ä—ã –æ—Ç –º–µ–Ω—è, –Ω–æ–≤—ã–µ –ø—Ä–æ–º—Ç—ã, –Ω–æ–≤–æ—Å—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ —ç–∫—Å–ø–µ—Ä—Ç—ã –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ

‚úÖ <b>–û–¥–∏–Ω –ø–ª–∞—Ç—ë–∂. –ù–∏–∫–∞–∫–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫. –ù–∞–≤—Å–µ–≥–¥–∞.</b>

‚è∞ –ß–µ—Ä–µ–∑ 72 —á–∞—Å–∞ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ç $90.
<b>–°–µ–π—á–∞—Å ‚Äî –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç –∑–∞–±—Ä–∞—Ç—å —Å–µ–±–µ –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø.</b>`;

  // –í–µ—Ä—Å–∏—è –¥–ª—è –º—É–∂—á–∏–Ω
  const maleVersion = `${name}, –ü—Ä–∏–≤–µ—Ç! üëã –£ –º–µ–Ω—è –¥–ª—è —Ç–µ–±—è –¥–≤–µ –Ω–æ–≤–æ—Å—Ç–∏ ‚ù§Ô∏è

–°–µ–≥–æ–¥–Ω—è <b>–ß—ë—Ä–Ω–∞—è –ü—è—Ç–Ω–∏—Ü–∞</b>, –∏ —è –∫–æ–µ-—á—Ç–æ –¥–ª—è —Ç–µ–±—è –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª–∞‚Ä¶

üî• <b>–ü–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∑–∞ $25</b> ‚Äî —Ç–æ–ª—å–∫–æ 72 —á–∞—Å–∞
–ü–æ—Ç–æ–º –ø—Ä–æ–º—Ç—ã, –∫–∞—Ä—Ç–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤, –≤–æ—Ä–∫–±—É–∫ –∏ —á–∞—Ç —Å—Ç–∞–Ω—É—Ç —á–∞—Å—Ç—å—é –∫–ª—É–±–∞ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ $30/–º–µ—Å.

–ú—ã —Ä–∞—Å—à–∏—Ä—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —á–∞—Ç –¥–æ –∫–ª—É–±–∞ "<b>Reels –ú–∞—Å—Ç–µ—Ä–∞</b>": —Ä–∞–∑–±–æ—Ä—ã, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é, –∫–æ–º—å—é–Ω–∏—Ç–∏, –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã ‚Äî –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ, –∏ —Ü–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç.

–ù–æ –≤ —á–µ—Å—Ç—å –ß—ë—Ä–Ω–æ–π –ü—è—Ç–Ω–∏—Ü—ã –∏ –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã —É–∂–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–º, <b>–∑–∞ —Ç–æ–±–æ–π –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –µ—â—ë 72 —á–∞—Å–∞.</b>

üíé <b>$25 –æ–¥–∏–Ω —Ä–∞–∑</b> ‚Üí –∏ –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω–æ –≤–Ω—É—Ç—Ä–∏:

üìä –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Å—ä—ë–º–∫–∏ —Ä–∏–ª—Å (34 —à—Ç)
ü§ñ 7 –ø—Ä–æ–º—Ç–æ–≤ –¥–ª—è —Å—ä—ë–º–∫–∏ —Ä–∏–ª—Å: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ê—Ä—Ö–µ—Ç–∏–ø–∞, –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¶–ê, –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 10 –∏–¥–µ–π, –ê–ø–≥—Ä–µ–π–¥ —Å—Ü–µ–Ω–∞—Ä–∏—è, –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –°–¢–ê, –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ö—É–∫–æ–≤, –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ–¥–ø–∏—Å–µ–π
üìà –í–æ—Ä–∫–±—É–∫-—Ç—Ä–µ–∫–µ—Ä –Ω–∞ 30 –¥–Ω–µ–π: –æ—Ç 0 –¥–æ 1000 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
üí¨ –î–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç–æ–µ –∫–æ–º–º—å—é–Ω–∏—Ç–∏ –≥–¥–µ –±—É–¥—É—Ç —ç—Ñ–∏—Ä—ã –∏ —Ä–∞–∑–±–æ—Ä—ã –æ—Ç –º–µ–Ω—è, –Ω–æ–≤—ã–µ –ø—Ä–æ–º—Ç—ã, –Ω–æ–≤–æ—Å—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ —ç–∫—Å–ø–µ—Ä—Ç—ã –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ

‚úÖ <b>–û–¥–∏–Ω –ø–ª–∞—Ç—ë–∂. –ù–∏–∫–∞–∫–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫. –ù–∞–≤—Å–µ–≥–¥–∞.</b>

‚è∞ –ß–µ—Ä–µ–∑ 72 —á–∞—Å–∞ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ç $90.
<b>–°–µ–π—á–∞—Å ‚Äî –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç –∑–∞–±—Ä–∞—Ç—å —Å–µ–±–µ –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø.</b>`;

  return gender === 'male' ? maleVersion : femaleVersion;
}

async function sendTestToAdmin() {
  console.log('üß™ –¢–ï–°–¢: –û—Ç–ø—Ä–∞–≤–∫–∞ Black Friday —Ä–∞—Å—Å—ã–ª–∫–∏ –∞–¥–º–∏–Ω—É...\n');

  try {
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î
    await AppDataSource.initialize();
    console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞\n');

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∞
    const userRepository = AppDataSource.getRepository(User);
    const adminUser = await userRepository.findOne({ 
      where: { userId: ADMIN_ID },
      select: ['userId', 'username', 'firstName', 'currentStep']
    });

    if (!adminUser) {
      console.error('‚ùå –ê–¥–º–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ!');
      process.exit(1);
    }

    console.log(`üë§ –ê–¥–º–∏–Ω: @${adminUser.username} (${adminUser.firstName})`);
    console.log(`üìç –¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø: ${adminUser.currentStep}\n`);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª
    const gender = detectGender(adminUser.firstName);
    console.log(`üîç –û–ø—Ä–µ–¥–µ–ª—ë–Ω –ø–æ–ª: ${gender === 'male' ? '‚ôÇÔ∏è –ú—É–∂—Å–∫–æ–π' : '‚ôÄÔ∏è –ñ–µ–Ω—Å–∫–∏–π'}\n`);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const message = generateMessage(adminUser.firstName, gender);
    console.log(`üìù –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${message.length} —Å–∏–º–≤–æ–ª–æ–≤\n`);
    
    // –°–æ–∑–¥–∞—ë–º inline –∫–Ω–æ–ø–∫—É
    const keyboard = Markup.inlineKeyboard([
      [Markup.button.callback('üíé –ó–∞–±—Ä–∞—Ç—å –¥–æ—Å—Ç—É–ø –∑–∞ $25', 'black_friday_payment')]
    ]);
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ñ–æ—Ç–æ...');
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –ë–ï–ó caption
    await bot.telegram.sendPhoto(
      ADMIN_ID,
      { source: IMAGE_PATH }
    );
    console.log('‚úÖ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ\n');
    
    // –ó–∞–¥–µ—Ä–∂–∫–∞ 100ms –º–µ–∂–¥—É —Ñ–æ—Ç–æ –∏ —Ç–µ–∫—Å—Ç–æ–º
    await new Promise(resolve => setTimeout(resolve, 100));
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ–∫—Å—Ç —Å –∫–Ω–æ–ø–∫–æ–π...');
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å –∫–Ω–æ–ø–∫–æ–π (–Ω–µ—Ç –ª–∏–º–∏—Ç–∞ –Ω–∞ –¥–ª–∏–Ω—É!)
    await bot.telegram.sendMessage(
      ADMIN_ID,
      message,
      { 
        reply_markup: keyboard.reply_markup,
        parse_mode: 'HTML'
      }
    );
    console.log('‚úÖ –¢–µ–∫—Å—Ç —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω\n');

    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
    console.log('üéâ –¢–µ—Å—Ç–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
    console.log('\n‚úÖ –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–π Telegram –∏ —É–±–µ–¥–∏—Å—å —á—Ç–æ –≤—Å—ë –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.');
    console.log('\nüí° –ï—Å–ª–∏ –≤—Å—ë –û–ö - –∑–∞–ø—É—Å–∫–∞–π –ø–æ–ª–Ω—É—é —Ä–∞—Å—Å—ã–ª–∫—É: npm run broadcast-bf\n');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

  } catch (error: any) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
    console.error('Stack:', error.stack);
    process.exit(1);
  } finally {
    await AppDataSource.destroy();
    process.exit(0);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º
sendTestToAdmin();
