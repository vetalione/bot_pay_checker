/**
 * –†–∞–∑–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞: –ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä –ø—Ä–æ Reels
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã)
 */

import * as dotenv from 'dotenv';
// –í–ê–ñ–ù–û: –∑–∞–≥—Ä—É–∂–∞–µ–º .env –î–û –∏–º–ø–æ—Ä—Ç–∞ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
dotenv.config();

import { Telegraf, Markup } from 'telegraf';
import { AppDataSource } from './src/database';
import { BroadcastHistory } from './src/entities/BroadcastHistory';

const bot = new Telegraf(process.env.BOT_TOKEN!);
const ADMIN_ID = 278263484; // ID –∞–¥–º–∏–Ω–∞

// –ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
const IMAGE_PATH = './Image_1_broadcast.jpeg';

// –¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏
const MESSAGE = `–ü—Ä–∏–≤–µ—Ç üëã

–°–µ–≥–æ–¥–Ω—è –≤ <b>14:00 –ø–æ –°–ù–ì</b> —É –º–µ–Ω—è –ø—Ä—è–º–æ–π —ç—Ñ–∏—Ä –≤ Telegram-–∫–∞–Ω–∞–ª–µ - –∏ –æ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω—ã–π.

–ï—Å–ª–∏ —Ç—ã —ç–∫—Å–ø–µ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–æ–¥–∞–∂–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–æ —á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å - —ç—Ç–æ—Ç —ç—Ñ–∏—Ä –¥–ª—è —Ç–µ–±—è.

<b>–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å Reels:</b>

–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å. –¢–æ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ –ø–æ–ª–≥–æ–¥–∞ –Ω–∞–∑–∞–¥ - –±–æ–ª—å—à–µ –Ω–µ –¥–∞—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –û—Ö–≤–∞—Ç—ã –ø–∞–¥–∞—é—Ç, –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–µ—Ç, –ø—Ä–æ–¥–∞–∂ - —Ç–æ–∂–µ.

<i>(–ï—Å–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏–ª —Å—Ç–æ—Ä–∏—Å - –∑–∞–π–¥–∏ –≤ —Ö–∞–π–ª–∞–π—Ç "–ß–¢–û –° –†–ò–õ–°" –≤ –º–æ–µ–π –∏–Ω—Å—Ç–µ –∏–ª–∏ –ø—Ä–æ—á–∏—Ç–∞–π –ø–æ—Å—Ç –≤—ã—à–µ –≤ —Ç–≥ –∫–∞–Ω–∞–ª–µ)</i>

<b>–•–æ—Ä–æ—à–∞—è –Ω–æ–≤–æ—Å—Ç—å:</b>

–ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —Ç–µ–±–µ. –ò —Ä–µ—à–µ–Ω–∏–µ - –Ω–µ "–ø–æ—Å—Ç–∏—Ç—å –±–æ–ª—å—à–µ" –∏ –Ω–µ "—Å–Ω–∏–º–∞—Ç—å –¥–æ—Ä–æ–≥–æ".

–°–µ–∫—Ä–µ—Ç –≤ <b>—Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ —Ü–µ–ª—å üéØ</b> - –∏ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö –æ—Ö–≤–∞—Ç–∞—Ö.

<b>–ù–∞ —ç—Ñ–∏—Ä–µ —Ä–∞–∑–±–µ—Ä—ë–º:</b>

‚úî –ö–∞–∫ —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é –∞—É–¥–∏—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç —Ü–µ–ø–ª—è–ª

‚úî –ö–∞–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤—ã–±–∏—Ä–∞—Ç—å (–∏ –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)

‚úî –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π —É–∑–Ω–∞–≤–∞–µ–º—ã–π –æ–±—Ä–∞–∑

–≠—Ç–æ –Ω–µ –ø—Ä–æ "–ª–∞–π—Ñ—Ö–∞–∫–∏" –∏ "—Ç—Ä–µ–Ω–¥—ã". –≠—Ç–æ –ø—Ä–æ —Å–∏—Å—Ç–µ–º—É, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–ª–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å –∏ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–ª—å—à–µ - –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Meta.

<b>–¢–µ–±–µ —Ç–æ—á–Ω–æ —Å—Ç–æ–∏—Ç –ø—Ä–∏–π—Ç–∏, –µ—Å–ª–∏:</b>

- –ù–µ –ø–æ–Ω–∏–º–∞–µ—à—å, <i>—á—Ç–æ –≤–æ–æ–±—â–µ —Å–Ω–∏–º–∞—Ç—å</i>
- –•–æ—á–µ—à—å –Ω–∞–±–∏—Ä–∞—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏ –æ—Ö–≤–∞—Ç—ã
- –•–æ—á–µ—à—å –ø–æ–ª—É—á–∞—Ç—å –ø—Ä–æ–¥–∞–∂–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç (–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ "–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç")

üïí <b>–£–∂–µ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞!</b>

üìç <b>–í –º–æ—ë–º Telegram-–∫–∞–Ω–∞–ª–µ</b>

–£–≤–∏–¥–∏–º—Å—è –Ω–∞ —ç—Ñ–∏—Ä–µ ‚ù§Ô∏è

–Æ–ª—è`;

async function sendToAdmin() {
  console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –ø—Ä–µ–≤—å—é —Ä–∞—Å—Å—ã–ª–∫–∏ "–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä –ø—Ä–æ Reels" –∞–¥–º–∏–Ω—É...\n');
  
  try {
    // 1. –°–Ω–∞—á–∞–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    await bot.telegram.sendPhoto(
      ADMIN_ID,
      { source: IMAGE_PATH }
    );
    
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // 2. –ü–æ—Ç–æ–º —Ç–µ–∫—Å—Ç
    await bot.telegram.sendMessage(
      ADMIN_ID,
      `<b>üß™ –ü–†–ï–í–¨–Æ –†–ê–°–°–´–õ–ö–ò: –ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä –ø—Ä–æ Reels</b>\n\n${MESSAGE}`,
      { parse_mode: 'HTML' }
    );
    
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // 3. –ó–∞—Ç–µ–º –∫–Ω–æ–ø–∫—É
    await bot.telegram.sendMessage(
      ADMIN_ID,
      'üëÜ –í–æ—Ç —Ç–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ä–∞—Å—Å—ã–ª–∫–∞\n\n' +
      '–ü–æ—Ä—è–¥–æ–∫:\n' +
      '1Ô∏è‚É£ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ Image_1_broadcast.jpeg\n' +
      '2Ô∏è‚É£ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è\n' +
      '3Ô∏è‚É£ –ö–Ω–æ–ø–∫–∞ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç—Ñ–∏—Ä" –Ω–∏–∂–µ ‚Üì',
      {
        reply_markup: {
          inline_keyboard: [[
            { text: 'üì∫ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç—Ñ–∏—Ä', url: 'https://t.me/mozgi_yuli' }
          ]]
        }
      }
    );
    
    console.log('‚úÖ –ü—Ä–µ–≤—å—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É!');
    console.log('üîò –ö–Ω–æ–ø–∫–∞ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç—Ñ–∏—Ä" –≤–µ–¥–µ—Ç –Ω–∞ https://t.me/mozgi_yuli');
    console.log('üñºÔ∏è  –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ Image_1_broadcast.jpeg\n');
    console.log('‚è≥ –ñ–¥—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏...');
    console.log('–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π: npm run broadcast-live-send\n');
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω—É:', error);
  }
  
  process.exit(0);
}

async function sendBroadcast() {
  console.log('üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É "–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä –ø—Ä–æ Reels"...\n');
  
  if (!AppDataSource.isInitialized) {
    await AppDataSource.initialize();
    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\n');
  }
  
  // –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∞–µ–º –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏ –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö, –∏ –Ω–µ –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö)
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π SQL –∑–∞–ø—Ä–æ—Å –∫ Railway –ë–î
  const users = await AppDataSource.query(`
    SELECT "userId", "firstName", "username"
    FROM users
    ORDER BY "userId"
  `);
  
  console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${users.length}`);
  console.log(`üéØ –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: –í–°–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞\n`);
  
  if (users.length === 0) {
    console.log('‚ö†Ô∏è –ù–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏');
    await AppDataSource.destroy();
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ë–î
  if (users.length < 100) {
    console.error('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');
    console.error(`–í –±–∞–∑–µ —Ç–æ–ª—å–∫–æ ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!`);
    console.error('–≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î, –∞ –Ω–µ Railway!');
    console.error('–†–∞—Å—Å—ã–ª–∫–∞ –ù–ï –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.');
    console.error('–ü—Ä–æ–≤–µ—Ä—å DATABASE_URL –≤ .env —Ñ–∞–π–ª–µ!\n');
    await AppDataSource.destroy();
    process.exit(1);
  }
  
  let sent = 0;
  let failed = 0;
  const errors: string[] = [];
  
  for (const user of users) {
    try {
      // 1. –°–Ω–∞—á–∞–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      await bot.telegram.sendPhoto(
        user.userId,
        { source: IMAGE_PATH }
      );
      
      // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // 2. –ü–æ—Ç–æ–º —Ç–µ–∫—Å—Ç
      await bot.telegram.sendMessage(
        user.userId,
        MESSAGE,
        { parse_mode: 'HTML' }
      );
      
      // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // 3. –ó–∞—Ç–µ–º –∫–Ω–æ–ø–∫—É
      await bot.telegram.sendMessage(
        user.userId,
        'üëá',
        {
          reply_markup: {
            inline_keyboard: [[
              { text: 'üì∫ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç—Ñ–∏—Ä', url: 'https://t.me/mozgi_yuli' }
            ]]
          }
        }
      );
      
      sent++;
      
      if (sent % 10 === 0) {
        console.log(`   –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${sent}/${users.length}...`);
      }
      
      // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ (—á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å —Ñ–ª—É–¥-–∫–æ–Ω—Ç—Ä–æ–ª—å)
      await new Promise(resolve => setTimeout(resolve, 200));
      
    } catch (error: any) {
      failed++;
      const errorMsg = `User ${user.userId}: ${error.message}`;
      errors.push(errorMsg);
      
      if (error.code === 403) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
      } else {
        console.error(`   ‚ùå ${errorMsg}`);
      }
    }
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –±–∞–∑—É
  const broadcastHistory = new BroadcastHistory();
  broadcastHistory.broadcastType = 'live_stream_reels';
  broadcastHistory.totalSent = sent;
  broadcastHistory.totalAttempted = users.length;
  broadcastHistory.segmentStart = 0; // –†–∞—Å—Å—ã–ª–∫–∞ –¥–ª—è –≤—Å–µ—Ö
  broadcastHistory.segmentVideo1 = 0;
  
  await AppDataSource.manager.save(broadcastHistory);
  
  // –û—Ç—á–µ—Ç
  console.log('\n============================================================');
  console.log('üìä –†–ê–°–°–´–õ–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê: –ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä –ø—Ä–æ Reels');
  console.log('============================================================');
  console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${sent}`);
  console.log(`‚ùå –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${failed}`);
  console.log(`üìà –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞: ${((sent / users.length) * 100).toFixed(1)}%`);
  console.log(`üéØ –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: –í–°–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏`);
  console.log('============================================================\n');
  
  if (errors.length > 0 && errors.length <= 10) {
    console.log('–û—à–∏–±–∫–∏:');
    errors.forEach(err => console.log(`  - ${err}`));
  }
  
  // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
  try {
    await bot.telegram.sendMessage(
      ADMIN_ID,
      `‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ "–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä –ø—Ä–æ Reels" –∑–∞–≤–µ—Ä—à–µ–Ω–∞</b>\n\n` +
      `üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${sent}/${users.length}\n` +
      `‚ùå –û—à–∏–±–æ–∫: ${failed}\n` +
      `üìà –£—Å–ø–µ—Ö: ${((sent / users.length) * 100).toFixed(1)}%\n` +
      `üéØ –ê—É–¥–∏—Ç–æ—Ä–∏—è: –í–°–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞`,
      { parse_mode: 'HTML' }
    );
  } catch (error) {
    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É');
  }
  
  await AppDataSource.destroy();
  process.exit(0);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
const args = process.argv.slice(2);

if (args.includes('--send')) {
  sendBroadcast();
} else {
  sendToAdmin();
}
