import { AppDataSource } from './src/database';

// –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ª–æ–≥–æ–≤ BF Day 3 (16.11.2025)
const blockedUserIds = [
  4727406, 40074234, 45552948, 75177609, 77435282, 89528793,
  119021353, 134753455, 147878558, 201045794, 220446675, 225382036,
  252961879, 269933924, 271688475, 283137883, 295404732, 319049114,
  322328534, 324366654, 327889818, 330138077, 333571936, 334946493,
  352498140, 352741679, 357459758, 372672981, 380925696, 380939785,
  385132404, 388629935, 412728855, 426150546, 428792981, 432508235,
  452191715, 489538594, 495331666, 507093866, 509742074, 531451278,
  534906195, 546732422, 548533898, 561959010, 575643537, 578096849,
  584179879, 618105007, 627505246, 632998362, 657770943, 662767361,
  664515029, 665676494, 675453154, 738308959, 742303648, 757780045,
  779921610, 792628738, 796010859, 807504129, 826360500, 869623213,
  880650186, 893292121, 895118816, 899585891, 905038515, 906787465,
  909609684, 924655176, 950395080, 951825408, 971528068, 1028698299,
  1033015787, 1045287296, 1077812583, 1093230824, 1151365806, 1228377191,
  1234916441, 1286917658, 1315753835, 1316514370, 1341373992, 1411944397,
  1740829472, 1873942568, 1874566694, 1920077783, 1922414680, 5092277524,
  5104354844, 5228960885, 5419968544, 6284113769, 6470708181, 6584653871,
  6610810187, 6683446378, 7105543163, 7162022416, 7964429482, 8475415551
];

async function markBlockedUsers() {
  try {
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...');
    await AppDataSource.initialize();
    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\n');

    console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${blockedUserIds.length}\n`);

    // –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–≤—à–∏—Ö
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º IN –≤–º–µ—Å—Ç–æ ANY –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å bigint
    const placeholders = blockedUserIds.map((_, i) => `$${i + 1}`).join(',');
    const result = await AppDataSource.query(
      `UPDATE users 
       SET "blockedBot" = true, 
           "blockedBotAt" = NOW()
       WHERE "userId" IN (${placeholders})
       RETURNING "userId", "firstName", "currentStep"`,
      blockedUserIds
    );

    console.log(`‚úÖ –ü–æ–º–µ—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${result.length}\n`);

    if (result.length > 0) {
      console.log('üìã –î–µ—Ç–∞–ª–∏ –ø–æ —ç—Ç–∞–ø–∞–º:');
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —ç—Ç–∞–ø–∞–º
      const byStep: Record<string, number> = {};
      result.forEach((user: any) => {
        const step = user.currentStep || 'unknown';
        byStep[step] = (byStep[step] || 0) + 1;
      });

      Object.entries(byStep).forEach(([step, count]) => {
        console.log(`   ${step}: ${count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
      });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–æ–ª—å–∫–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    const notFound = blockedUserIds.length - result.length;
    if (notFound > 0) {
      console.log(`\n‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ: ${notFound} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
    }

    console.log('\n‚úÖ –ì–æ—Ç–æ–≤–æ!');
    await AppDataSource.destroy();
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
    process.exit(1);
  }
}

markBlockedUsers();
