# üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìã –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: `telegram_bot`

---

## 1Ô∏è‚É£ –¢–∞–±–ª–∏—Ü–∞ `users` - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—è:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| **userId** | bigint | Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Primary Key) |
| **username** | varchar | @username –∏–∑ Telegram |
| **firstName** | varchar | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **lastName** | varchar | –§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **currentStep** | varchar | –¢–µ–∫—É—â–∏–π —à–∞–≥ –≤ –≤–æ—Ä–æ–Ω–∫–µ |
| **currency** | varchar | –í—ã–±—Ä–∞–Ω–Ω–∞—è –≤–∞–ª—é—Ç–∞ (RUB/UAH) |
| **hasPaid** | boolean | –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã (true/false) |
| **paidAt** | timestamp | –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã |
| **lastActivityAt** | timestamp | –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **createdAt** | timestamp | –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–ø–µ—Ä–≤—ã–π /start) |
| **updatedAt** | timestamp | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

### –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `currentStep`:
- `start` - –ù–∞—á–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø (/start)
- `video1` - –ü–æ—Å–º–æ—Ç—Ä–µ–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –∂–¥–µ—Ç video1
- `video2` - –ü–æ—Å–º–æ—Ç—Ä–µ–ª video1, –∂–¥–µ—Ç video2
- `video3` - –ü–æ—Å–º–æ—Ç—Ä–µ–ª video2, –∂–¥–µ—Ç video3
- `payment_choice` - –í—ã–±–∏—Ä–∞–µ—Ç –≤–∞–ª—é—Ç—É –¥–ª—è –æ–ø–ª–∞—Ç—ã
- `waiting_receipt` - –û–∂–∏–¥–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ–∫–∞
- `completed` - –£—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—Ç–∏–ª

### –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `currency`:
- `RUB` - –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å (2000‚ÇΩ)
- `UAH` - –£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –≥—Ä–∏–≤–Ω–∞ (1050‚Ç¥)

---

## 2Ô∏è‚É£ –¢–∞–±–ª–∏—Ü–∞ `user_actions` - –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—è:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| **id** | integer | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–µ–π—Å—Ç–≤–∏—è (Auto-increment) |
| **userId** | bigint | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Foreign Key ‚Üí users) |
| **action** | varchar | –ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è |
| **step** | varchar | –®–∞–≥ –≤–æ—Ä–æ–Ω–∫–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—è |
| **metadata** | jsonb | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON) |
| **timestamp** | timestamp | –í—Ä–µ–º—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è |

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (`action`):

| Action | –û–ø–∏—Å–∞–Ω–∏–µ | –ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç |
|--------|----------|------------------|
| **start** | –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª /start |
| **click_want_more** | –ö–ª–∏–∫ "–•–æ—á—É!" | –ù–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "üî• –•–æ—á—É!" –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è |
| **choose_rub** | –í—ã–±—Ä–∞–ª RUB | –ù–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "üíµ –û–ø–ª–∞—Ç–∏—Ç—å –≤ RUB" |
| **choose_uah** | –í—ã–±—Ä–∞–ª UAH | –ù–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "üí¥ –û–ø–ª–∞—Ç–∏—Ç—å –≤ UAH" |
| **payment_success** | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ | –ß–µ–∫ –ø—Ä–æ—à–µ–ª –≤–∞–ª–∏–¥–∞—Ü–∏—é, –ø–æ–ª—É—á–∏–ª –∏–Ω–≤–∞–π—Ç —Å—Å—ã–ª–∫–∏ |

### Metadata (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ):
–í –ø–æ–ª–µ `metadata` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è JSON —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:
```json
{
  "username": "vetalsmirnov",
  "firstName": "Vitaliy",
  "lastName": "Smirnov"
}
```

---

## 3Ô∏è‚É£ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏

### üìà –í–æ—Ä–æ–Ω–∫–∞ (Funnel):
```sql
SELECT currentStep, COUNT(*) as users
FROM users
GROUP BY currentStep
ORDER BY users DESC;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `start` - –°–∫–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–∏
- `video1` - –°–∫–æ–ª—å–∫–æ –¥–æ—à–ª–∏ –¥–æ video1
- `waiting_receipt` - –°–∫–æ–ª—å–∫–æ –¥–æ—à–ª–∏ –¥–æ –æ–ø–ª–∞—Ç—ã
- `completed` - –°–∫–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏

### üí∞ –ö–æ–Ω–≤–µ—Ä—Å–∏—è:
```sql
SELECT 
  COUNT(*) as total,
  SUM(CASE WHEN "hasPaid" = true THEN 1 ELSE 0 END) as paid,
  ROUND(100.0 * SUM(CASE WHEN "hasPaid" = true THEN 1 ELSE 0 END) / COUNT(*), 2) as conversion_rate
FROM users;
```

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Total users - –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Paid users - –û–ø–ª–∞—Ç–∏–≤—à–∏—Ö
- Conversion rate (%) - –ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

### üìä –ü–æ –≤–∞–ª—é—Ç–∞–º:
```sql
SELECT currency, COUNT(*) as users
FROM users
WHERE currency IS NOT NULL
GROUP BY currency;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- RUB - –°–∫–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–ª–∏ —Ä—É–±–ª–∏
- UAH - –°–∫–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–ª–∏ –≥—Ä–∏–≤–Ω—ã

### ‚è± –í—Ä–µ–º—è –≤ –≤–æ—Ä–æ–Ω–∫–µ:
```sql
SELECT 
  "userId",
  MIN(timestamp) as first_action,
  MAX(timestamp) as last_action,
  MAX(timestamp) - MIN(timestamp) as time_in_funnel
FROM user_actions
GROUP BY "userId";
```

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç /start –¥–æ payment
- –°–∞–º—ã–µ –±—ã—Å—Ç—Ä—ã–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
- –ó–∞—Å—Ç—Ä—è–≤—à–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

---

## 4Ô∏è‚É£ Retargeting —Å–µ–≥–º–µ–Ω—Ç—ã

### üéØ –ó–∞—Å—Ç—Ä—è–≤—à–∏–µ –Ω–∞ video1 (24—á+):
```sql
SELECT * FROM users
WHERE "currentStep" = 'video1'
  AND "hasPaid" = false
  AND "lastActivityAt" < NOW() - INTERVAL '24 hours';
```

### üéØ –ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (24—á+):
```sql
SELECT * FROM users
WHERE "currentStep" IN ('payment_choice', 'waiting_receipt')
  AND "hasPaid" = false
  AND "lastActivityAt" < NOW() - INTERVAL '24 hours';
```

### üéØ –û–ø–ª–∞—Ç–∏–≤—à–∏–µ (–¥–ª—è –¥–æ–ø—Ä–æ–¥–∞–∂):
```sql
SELECT * FROM users
WHERE "hasPaid" = true;
```

### üéØ –ù–æ–≤—ã–µ (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á):
```sql
SELECT * FROM users
WHERE "createdAt" > NOW() - INTERVAL '24 hours';
```

---

## 5Ô∏è‚É£ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å tracking

### ‚úÖ –ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –°–ï–ô–ß–ê–°:

#### –î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. ‚úÖ **–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞** (`/start`)
2. ‚úÖ **–ö–ª–∏–∫ "–•–æ—á—É!"** (–ø–µ—Ä–µ—Ö–æ–¥ –∫ –≤–æ—Ä–æ–Ω–∫–µ)
3. ‚úÖ **–í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã** (RUB/UAH)
4. ‚úÖ **–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞** (–ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —á–µ–∫–∞)

#### –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. ‚úÖ Telegram ID, username, –∏–º—è, —Ñ–∞–º–∏–ª–∏—è
2. ‚úÖ –¢–µ–∫—É—â–∏–π —à–∞–≥ –≤ –≤–æ—Ä–æ–Ω–∫–µ
3. ‚úÖ –í—ã–±—Ä–∞–Ω–Ω–∞—è –≤–∞–ª—é—Ç–∞
4. ‚úÖ –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã (–¥–∞/–Ω–µ—Ç)
5. ‚úÖ –í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã
6. ‚úÖ –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
7. ‚úÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

---

## 6Ô∏è‚É£ –ß—Ç–æ –ú–û–ñ–ù–û –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### üîÆ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
- ‚ùå –ü—Ä–æ—Å–º–æ—Ç—Ä video1, video2, video3
- ‚ùå –ö–ª–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ "–°–º–æ—Ç—Ä–µ—Ç—å –¥–∞–ª—å—à–µ", "–ì–æ—Ç–æ–≤!"
- ‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ–∫–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—à–µ–ª –≤–∞–ª–∏–¥–∞—Ü–∏—é)
- ‚ùå –û—Ç–∫–∞–∑ –æ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —á–µ–∫–∞
- ‚ùå –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ –∏–Ω–≤–∞–π—Ç —Å—Å—ã–ª–∫–∞–º

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- ‚ùå –ò—Å—Ç–æ—á–Ω–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞ (–æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª)
- ‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (iOS/Android/Desktop)
- ‚ùå –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- ‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è (–ø–æ IP –∏–ª–∏ Telegram)
- ‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ–∫–∞

#### Behavioral –º–µ—Ç—Ä–∏–∫–∏:
- ‚ùå –í—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–µ–æ
- ‚ùå –°–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤–æ—Ä–æ–Ω–∫–∏
- ‚ùå Drop-off —Ç–æ—á–∫–∏ (–≥–¥–µ –æ—Ç–≤–∞–ª–∏–≤–∞—é—Ç—Å—è)
- ‚ùå Re-engagement (–≤–æ–∑–≤—Ä–∞—Ç—ã –ø–æ—Å–ª–µ –ø–∞—É–∑—ã)

---

## 7Ô∏è‚É£ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### üìà –ê–Ω–∞–ª–∏–∑ –≤–æ—Ä–æ–Ω–∫–∏:
```bash
npm run retargeting stats
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —à–∞–≥–∞–º
```

### üí∞ –ö–æ–Ω–≤–µ—Ä—Å–∏—è:
```bash
npm run retargeting conversion
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç % –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö
```

### üéØ Retargeting –∫–∞–º–ø–∞–Ω–∏–∏:
```bash
# –ù–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à–∏–º –Ω–∞ video1
npm run retargeting stuck_video1

# –ù–∞–ø–æ–º–Ω–∏—Ç—å –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç–µ
npm run retargeting abandoned_payment
```

### üîç SQL –∑–∞–ø—Ä–æ—Å—ã:
```sql
-- –°—Ä–µ–¥–Ω—è—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ –≤–∞–ª—é—Ç–∞–º
SELECT 
  currency,
  COUNT(*) as total,
  SUM(CASE WHEN "hasPaid" = true THEN 1 ELSE 0 END) as paid,
  ROUND(100.0 * SUM(CASE WHEN "hasPaid" = true THEN 1 ELSE 0 END) / COUNT(*), 2) as rate
FROM users
WHERE currency IS NOT NULL
GROUP BY currency;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–µ–π—Å—Ç–≤–∏–π
SELECT 
  u."userId",
  u.username,
  COUNT(a.id) as actions_count
FROM users u
LEFT JOIN user_actions a ON u."userId" = a."userId"
GROUP BY u."userId", u.username
ORDER BY actions_count DESC
LIMIT 10;

-- –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤–æ—Ä–æ–Ω–∫–∏
SELECT 
  AVG(EXTRACT(EPOCH FROM (MAX(timestamp) - MIN(timestamp)))) / 60 as avg_minutes
FROM user_actions
GROUP BY "userId"
HAVING COUNT(*) >= 2;
```

---

## üìä Summary

### –¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ tracking:

**Users table:**
- ‚úÖ 11 –ø–æ–ª–µ–π
- ‚úÖ 4 —à–∞–≥–∞ –≤–æ—Ä–æ–Ω–∫–∏
- ‚úÖ 2 –≤–∞–ª—é—Ç—ã

**User_actions table:**
- ‚úÖ 5 —Ç–∏–ø–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å timestamps
- ‚úÖ Metadata –≤ JSON

**Analytics:**
- ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ –ø–æ —à–∞–≥–∞–º
- ‚úÖ –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –æ–ø–ª–∞—Ç—É
- ‚úÖ Retargeting —Å–µ–≥–º–µ–Ω—Ç—ã
- ‚úÖ –í—Ä–µ–º—è –≤ –≤–æ—Ä–æ–Ω–∫–µ

**Retargeting –≥–æ—Ç–æ–≤:**
- ‚úÖ –ó–∞—Å—Ç—Ä—è–≤—à–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- ‚úÖ –ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞
- ‚úÖ –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –≤–∞–ª—é—Ç–µ
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã

---

**–î–∞—Ç–∞:** 2 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** PRODUCTION READY ‚úÖ
