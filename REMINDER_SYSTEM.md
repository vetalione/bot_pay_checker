# üîî –°–∏—Å—Ç–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –≤—ã–±–æ—Ä–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã

## –û–±–∑–æ—Ä

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ—à–ª–∏ –¥–æ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã, –Ω–æ –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –≤—ã–±–æ—Ä –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—ã–±–æ—Ä –æ–ø–ª–∞—Ç—ã
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—à–µ–ª –¥–æ —ç—Ç–∞–ø–∞ –≤—ã–±–æ—Ä–∞ –æ–ø–ª–∞—Ç—ã (—Ä—É–±–ª–∏/–≥—Ä–∏–≤–Ω—ã), –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:
- `paymentChoiceShownAt` - —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞
- `paymentReminderSent` - —Ñ–ª–∞–≥ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ `false`)

### 2. –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
–ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É `ReminderService` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- ‚úÖ –®–∞–≥: `payment_choice`
- ‚úÖ –í–∞–ª—é—Ç–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ (`null`)
- ‚úÖ –í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞: –±–æ–ª—å—à–µ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

### 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
–•–æ—á–µ—à—å –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã?
```

**–ö–Ω–æ–ø–∫–∞:**
```
üì® –ù–∞–ø–∏—Å–∞—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É ‚Üí https://t.me/vetalsmirnov
```

### 4. –û—Ç–º–µ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏:
- `paymentReminderSent` ‚Üí `true`
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

### 5. –°–±—Ä–æ—Å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–ø–ª–∞—Ç—ã
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ä—É–±–ª–∏ –∏–ª–∏ –≥—Ä–∏–≤–Ω—ã:
- `paymentReminderSent` ‚Üí `false`
- `paymentChoiceShownAt` ‚Üí `null`
- –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤–æ–º—É —Ü–∏–∫–ª—É (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω–µ—Ç—Å—è –∫ –≤—ã–±–æ—Ä—É)

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `paymentChoiceShownAt` | timestamp | –í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –≤—ã–±–æ—Ä–∞ –æ–ø–ª–∞—Ç—ã |
| `paymentReminderSent` | boolean | –§–ª–∞–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è |

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

- `src/reminderService.ts` - –°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
- `src/entities/User.ts` - –û–±–Ω–æ–≤–ª–µ–Ω–∞ Entity —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
- `src/userService.ts` - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `markPaymentChoiceShown()`

### –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏

- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- **–ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:** 5 –º–∏–Ω—É—Ç
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:** –Ω–µ—Ç (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í –ª–æ–≥–∞—Ö Railway –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã:

```
üîî –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π...
üìä –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: 3
üîî –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 123456789
‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 123456789
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –õ–µ–≥–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î (1 –∑–∞–ø—Ä–æ—Å –≤ –º–∏–Ω—É—Ç—É)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞

## Graceful Shutdown

–ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞:
```typescript
process.once('SIGTERM', () => {
  reminderService.stop(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª
  bot.stop('SIGTERM');
});
```

## SQL –∑–∞–ø—Ä–æ—Å (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)

–°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É:
```sql
SELECT * FROM users
WHERE 
  currentStep = 'payment_choice'
  AND currency IS NULL
  AND paymentReminderSent = false
  AND paymentChoiceShownAt <= NOW() - INTERVAL '5 minutes';
```

## –ü—Ä–∏–º–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
1. **14:00** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—ã–±–æ—Ä –æ–ø–ª–∞—Ç—ã
2. **14:05** - –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
3. **14:07** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∏ –ø–∏—à–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –í—ã–±–æ—Ä –¥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
1. **14:00** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—ã–±–æ—Ä –æ–ø–ª–∞—Ç—ã
2. **14:03** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ä—É–±–ª–∏
3. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (–≤–∞–ª—é—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞)

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **14:00** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—ã–±–æ—Ä –æ–ø–ª–∞—Ç—ã
2. **14:05** - –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
3. **14:10+** - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL:

```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –æ–∂–∏–¥–∞—é—â–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
SELECT userId, username, paymentChoiceShownAt, paymentReminderSent
FROM users
WHERE currentStep = 'payment_choice' 
  AND currency IS NULL
ORDER BY paymentChoiceShownAt DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
SELECT 
  COUNT(*) as total_reminders_sent
FROM users
WHERE paymentReminderSent = true;
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–¥–µ—Ä–∂–∫–∏

–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å 5 –º–∏–Ω—É—Ç –Ω–∞ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:

–í —Ñ–∞–π–ª–µ `src/reminderService.ts`:
```typescript
private readonly REMINDER_DELAY_MS = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
```

–ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:
```typescript
private readonly REMINDER_DELAY_MS = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç
```
